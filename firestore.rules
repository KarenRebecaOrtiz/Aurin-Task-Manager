rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Function to check if the user is an admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.access == 'admin';
    }

    // Function to check if user is involved in a task (assigned, leading, or created)
    function isInvolvedInTask(taskId) {
      return request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/tasks/$(taskId)).data.AssignedTo ||
        request.auth.uid in get(/databases/$(database)/documents/tasks/$(taskId)).data.LeadedBy ||
        request.auth.uid == get(/databases/$(database)/documents/tasks/$(taskId)).data.CreatedBy
      );
    }

    // Verificar si la tarea esta compartida publicamente con comentarios habilitados
    function isTaskPubliclyShared(taskId) {
      let taskData = get(/databases/$(database)/documents/tasks/$(taskId)).data;
      return taskData.shared == true && taskData.commentsEnabled == true;
    }

    // Verificar si el usuario es miembro de un equipo
    function isTeamMember(teamId) {
      return request.auth != null &&
             request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.memberIds;
    }

    // Verificar si el equipo es publico
    function isTeamPublic(teamId) {
      return get(/databases/$(database)/documents/teams/$(teamId)).data.isPublic == true;
    }

    // Tasks collection
    match /tasks/{taskId} {
      // Solo admins o usuarios involucrados pueden leer tareas
      allow read: if request.auth != null && (isAdmin() || isInvolvedInTask(taskId));

      // Para list (consultas), permitir solo a admins por seguridad
      // El filtrado detallado se maneja en el frontend
      allow list: if request.auth != null;

      // Todos los usuarios autenticados pueden crear tareas
      allow create: if request.auth != null &&
                    request.resource.data.CreatedBy == request.auth.uid;

      // PERMITIR ACTUALIZACION DE CAMPOS DE SHARING: Solo admins
      allow update: if isAdmin() &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['shared', 'shareToken',
'shareExpiresAt', 'shareAccessCount',
'shareMaxAccess', 'shareLastAccess', 'commentsEnabled', 'updatedAt']);

      // Admins pueden editar/eliminar cualquier tarea,
      // usuarios pueden editar tareas donde estan involucrados
      // PERMITIR ACTUALIZACION DE lastViewedBy y unreadCountByUser para usuarios involucrados
      allow update: if isAdmin() ||
                    (request.auth != null && isInvolvedInTask(taskId)) ||
                    (request.auth != null &&
                     (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastViewedBy',
'unreadCountByUser', 'hasUnreadUpdates']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastViewedBy']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['unreadCountByUser']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['hasUnreadUpdates'])));

      // Solo admins pueden eliminar tareas
      allow delete: if isAdmin();

      // MENSAJES EN TAREAS
      match /messages/{messageId} {
        // LECTURA:
        // - Usuarios involucrados en la tarea
        // - Invitados en tareas compartidas publicamente
        allow read, list: if (request.auth != null && (isAdmin() || isInvolvedInTask(taskId))) ||
                          isTaskPubliclyShared(taskId);

        // CREACION:
        // - Usuarios involucrados: pueden enviar mensajes normales o de agente
        // - Usuarios autenticados NO involucrados: pueden enviar en tareas publicas
        // - Invitados (no autenticados): pueden enviar en tareas publicas con senderId == 'guest'
        allow create: if (
                       // Usuarios involucrados en la tarea
                       (request.auth != null && isInvolvedInTask(taskId) && (
                         request.resource.data.senderId == request.auth.uid ||
                         request.resource.data.senderId == 'gemini'
                       ))
                     ) || (
                       // Tareas compartidas publicamente
                       isTaskPubliclyShared(taskId) && (
                         // Usuario autenticado (cualquiera)
                         request.auth != null ||
                         // Invitado (senderId debe ser 'guest')
                         (request.auth == null && request.resource.data.senderId == 'guest')
                       )
                     );

        // ACTUALIZACION/ELIMINACION:
        // - Admins
        // - Autor del mensaje (si esta involucrado en la tarea)
        // - NO permitir a invitados editar/eliminar
        allow update, delete: if request.auth != null &&
                             (isAdmin() || (resource.data.senderId == request.auth.uid && isInvolvedInTask(taskId)));
      }

      // Timers en tareas
      match /timers/{userId} {
        // PERMITIR LECTURA: Todos los usuarios autenticados pueden leer timers
        allow read: if request.auth != null;

        // PERMITIR ESCRITURA: Admins o el propio usuario
        allow write: if request.auth != null &&
                    (isAdmin() || request.auth.uid == userId);
      }

      // Time logs en tareas (entradas de tiempo manual y de timer)
      match /time_logs/{logId} {
        // PERMITIR LECTURA: Todos los usuarios autenticados involucrados en la tarea
        allow read: if request.auth != null;

        // PERMITIR CREACION: Usuarios autenticados pueden crear sus propios logs
        allow create: if request.auth != null &&
                     request.resource.data.userId == request.auth.uid;

        // PERMITIR ACTUALIZACION/ELIMINACION: Admins o el creador del log
        allow update, delete: if request.auth != null &&
                             (isAdmin() || resource.data.userId == request.auth.uid);
      }

      // Typing indicators en tareas
      match /typing/{userId} {
        // PERMITIR LECTURA: Todos los usuarios autenticados pueden leer typing
        allow read: if request.auth != null;

        // PERMITIR ESCRITURA: Admins o el propio usuario
        allow write: if request.auth != null &&
                    (isAdmin() || request.auth.uid == userId);
      }
    }

    // ============================================================================
    // TEAMS COLLECTION - Equipos de colaboracion (chats grupales)
    // ============================================================================
    match /teams/{teamId} {
      // LECTURA: Admins, miembros del equipo, o si el equipo es publico
      allow read: if request.auth != null &&
                  (isAdmin() || isTeamMember(teamId) || isTeamPublic(teamId));

      // LISTAR: Usuarios autenticados (el filtrado se hace en frontend)
      allow list: if request.auth != null;

      // CREACION: Usuarios autenticados, creador debe estar en memberIds
      allow create: if request.auth != null &&
                    request.resource.data.createdBy == request.auth.uid &&
                    request.auth.uid in request.resource.data.memberIds;

      // ACTUALIZACION: Admins o miembros del equipo
      allow update: if request.auth != null &&
                    (isAdmin() || isTeamMember(teamId));

      // ELIMINACION: Solo admins o el creador del equipo
      allow delete: if request.auth != null &&
                    (isAdmin() || resource.data.createdBy == request.auth.uid);

      // MENSAJES EN EQUIPOS
      match /messages/{messageId} {
        // LECTURA: Admins, miembros del equipo, o si el equipo es publico
        allow read, list: if request.auth != null &&
                          (isAdmin() || isTeamMember(teamId) || isTeamPublic(teamId));

        // CREACION: Miembros del equipo o admins
        allow create: if request.auth != null &&
                     (isAdmin() || isTeamMember(teamId)) &&
                     request.resource.data.senderId == request.auth.uid;

        // ACTUALIZACION/ELIMINACION: Admins o autor del mensaje (si es miembro)
        allow update, delete: if request.auth != null &&
                             (isAdmin() ||
                              (resource.data.senderId == request.auth.uid && isTeamMember(teamId)));
      }

      // TYPING INDICATORS EN EQUIPOS
      match /typing/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null &&
                    (isAdmin() || request.auth.uid == userId);
      }
    }

    // Clients collection
    match /clients/{clientId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Users collection
    match /users/{userId} {
      // Todos pueden leer usuarios (para ver status)
      allow read: if request.auth != null;
      // Solo el dueno o admin puede crear/modificar
      allow create, update: if request.auth != null &&
                           (request.auth.uid == userId || isAdmin());

      // PREFERENCIAS DE USUARIO (subcoleccion - incluye pinnedTasks)
      match /preferences/{prefId} {
        // Solo el usuario propietario puede leer sus preferencias
        allow read: if request.auth != null && request.auth.uid == userId;

        // Solo el usuario propietario puede escribir sus preferencias
        allow write: if request.auth != null
                     && request.auth.uid == userId
                     && (
                       (prefId == 'pinnedTasks' &&
                        request.resource.data.pinnedTaskIds is list &&
                        request.resource.data.pinnedTaskIds.size() <= 5) ||
                       prefId != 'pinnedTasks'
                     );
      }
    }

    // Todos collection
    match /todos/{todoId} {
      // PERMITIR LECTURA: Usuarios pueden leer sus propios todos
      allow read: if request.auth != null &&
                  resource.data.userId == request.auth.uid;

      // PERMITIR CREACION: Usuarios autenticados pueden crear sus propios todos
      allow create: if request.auth != null &&
                   request.resource.data.userId == request.auth.uid;

      // PERMITIR ACTUALIZACION: Usuarios pueden actualizar sus propios todos
      allow update: if request.auth != null &&
                   resource.data.userId == request.auth.uid;

      // PERMITIR ELIMINACION: Usuarios pueden eliminar sus propios todos
      allow delete: if request.auth != null &&
                   resource.data.userId == request.auth.uid;
    }

    // Email Limits collection - Para control de limites de email por usuario
    match /emailLimits/{userId} {
      // PERMITIR LECTURA: Solo el propio usuario puede leer sus limites
      allow read: if request.auth != null && request.auth.uid == userId;

      // PERMITIR ESCRITURA: Solo el propio usuario puede crear/actualizar sus limites
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // PERMITIR ELIMINACION: Solo admins pueden eliminar limites
      allow delete: if isAdmin();
    }

    // Notes collection - Notas publicas temporales de usuarios (expiran en 24h)
    match /notes/{noteId} {
      // PERMITIR LECTURA: Todos los usuarios autenticados pueden ver las notas
      allow read: if request.auth != null;

      // PERMITIR CREACION: Usuarios autenticados pueden crear sus propias notas
      allow create: if request.auth != null &&
                   request.resource.data.userId == request.auth.uid;

      // PERMITIR ACTUALIZACION: Solo el propietario puede actualizar su nota
      allow update: if request.auth != null &&
                   resource.data.userId == request.auth.uid;

      // PERMITIR ELIMINACION: El propietario o admins pueden eliminar
      allow delete: if request.auth != null &&
                   (resource.data.userId == request.auth.uid || isAdmin());
    }
  }
}
